> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ https://juejin.im/entry/58f5b68e61ff4b005807ab47 ![](http://upload-images.jianshu.io/upload_images/1869462-1ee9c9600c8ac2cd.png?imageMogr2/auto-orient/strip%7CimageView2/2)
_Android_

# èƒŒæ™¯ä»‹ç»

ä»äº‹å¼€å‘åˆ°äº†ä¸€å®šé˜¶æ®µï¼Œæƒ³è¦æé«˜å°±å¿…é¡»ææ˜ç™½ç³»ç»Ÿçš„ä¸€äº›å·¥ä½œåŸç†ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºåªæœ‰æ˜ç™½äº†è¿™äº›ï¼Œä½ æ‰èƒ½é’ˆå¯¹å¹³å°çš„ç‰¹æ€§å†™å‡ºä¼˜è´¨çš„ä»£ç ã€‚å½“é‡åˆ°æ£˜æ‰‹çš„é—®é¢˜æ—¶ï¼Œä½ æ‰èƒ½æ›´å¿«é€Ÿçš„ç»“åˆç³»ç»ŸåŸç†å»å¯»æ‰¾æœ€ä¼˜è§£å†³æ–¹æ¡ˆã€‚åº•å±‚åŸºç¡€å†³å®šä¸Šå±‚å»ºç­‘ã€‚è¿™ä¸ªåŸç†åœ¨å¼€å‘ä¸­åŒæ ·é€‚ç”¨ã€‚æˆ‘æ˜¯æå€¡ **å›å½’åŸºç¡€** çš„ã€‚é«˜çº§çš„åŠŸèƒ½æ€»æ˜¯ç”±æœ€åŸºæœ¬çš„å…ƒä»¶æ„æˆï¼Œå°±å¥½æ¯”ä¸ºæ•°ä¸å¤šçš„å…ƒç´ æ„æˆäº†æˆ‘ä»¬éš¾ä»¥æƒ³è±¡çš„ä¸°å¯Œçš„ç‰©è´¨ä¸–ç•Œä¸€æ ·ã€‚**åªæœ‰æŒæ¡äº†æœ€æ ¹æœ¬çš„å†…å®¹ï¼Œæ‰èƒ½ä¿ƒä½¿ä½ çˆ†å‘å‡ºéš¾ä»¥æƒ³è±¡çš„åˆ›é€ åŠ›æ¥ï¼**

é‡è§†åŸºç¡€ï¼Œå›å½’åŸºç¡€ã€‚å›åˆ°æœ€åˆï¼Œå»æ¢å¯»çµæ„Ÿã€‚ æ„¿ä¸å›å…±å‹‰âœŒï¸ï¼

# ä¸€å¼ å›¾æ˜ç™½ Activity çš„å¯åŠ¨æµç¨‹

![](http://upload-images.jianshu.io/upload_images/1869462-882b8e0470adf85a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2)
_Activity å¯åŠ¨æµç¨‹_

æœ¬ç¯‡ä¸»è¦è®²çš„æ˜¯ä»ä¸€ä¸ª App å¯åŠ¨ï¼Œåˆ° Activity æ‰§è¡Œ onCreate() çš„æµç¨‹ã€‚åé¢å…³äº Activity çš„ç”Ÿå‘½å‘¨æœŸç›¸ä¿¡å¤§å®¶åŸºæœ¬éƒ½è€³ç†Ÿèƒ½è¯¦äº†ã€‚

ä¸Šå›¾ä¸­æˆ‘æŠŠæ¶‰åŠåˆ°çš„ç±»åæ–¹æ³•å‘½å‡åˆ—å‡ºæ¥äº†ï¼Œä½ å¯ä»¥çœ‹ç€æµç¨‹ï¼Œæ‰“å¼€æºç è·Ÿç€è¿‡ä¸€éã€‚ç›¸ä¿¡åœ¨è¿‡å®Œä¸€éä¹‹åï¼Œåœ¨ä»Šåçš„å¼€å‘ä¸­ä½ ä¼šæ›´åŠ è‡ªä¿¡ï¼

ä¸Šå›¾ä¹ä¸€çœ‹å¯èƒ½æ„Ÿè§‰æœ‰äº›çœ¼èŠ±ç¼­ä¹±ï¼Œä½†è¯·ä¸è¦æƒ§æ€•ã€‚å…¶å®æ ¹æœ¬å°±æ²¡ä»€ä¹ˆä¸œè¥¿ğŸ˜‚ï¼Œä½ åªéœ€è¦ä»è“è‰²ç®­å¤´å¼€å§‹çœ‹ä¸‹å»ï¼Œä¼šå‘ç°ä¸€ä¸‹å°±çœ‹å®Œäº†ã€‚åœ¨ç»“åˆä¸‹é¢ç®€è¦çš„åˆ†æï¼Œ3 åˆ†é’Ÿå†…ä½ å°±èƒ½ææ˜ç™½ Activity çš„å¯åŠ¨æµç¨‹ã€‚

å…³äº Activity çš„å¯åŠ¨ï¼Œæˆ‘åœ¨[ã€æƒŠå¤©ç§˜å¯†ï¼ä» Thread å¼€å§‹ï¼Œæ­éœ² Android çº¿ç¨‹é€šè®¯çš„è¯¡è®¡å’Œä¸»çº¿ç¨‹çš„é˜´è°‹ã€‘http://www.jianshu.com/p/8862bd2b6a29](https://link.juejin.im?target=http%3A%2F%2Fwww.jianshu.com%2Fp%2F8862bd2b6a29) ä¸€æ–‡ä¸­æœ‰æåˆ°è¿‡ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è®²çš„æ˜¯ Thread çº¿ç¨‹åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œä»¥åŠ Android ä¸­çš„æ¶ˆæ¯æœºåˆ¶ã€‚æ„Ÿå…´è¶£å¯ä»¥ç‚¹é“¾æ¥çœ‹ä¸€çœ‹ã€‚

## ä¸€åˆ‡ä» main() æ–¹æ³•å¼€å§‹

Android ä¸­ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºçš„å¼€å§‹å¯ä»¥è¯´å°±æ˜¯ä» **ActivityThread.java** ä¸­çš„ main() æ–¹æ³•å¼€å§‹çš„ã€‚éƒ½æ˜¯å­¦è¿‡ Java çš„äººï¼Œæƒ³å¿…ä¹Ÿéƒ½çŸ¥é“ Java çš„ç¨‹åºå…¥å£å°±æ˜¯ main() æ–¹æ³•ã€‚Android å…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ª Java ç¨‹åºè€Œå·²ã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œmain() æ–¹æ³•ä¸­ä¸»è¦åšçš„äº‹æƒ…æœ‰ï¼š

1.  åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„ Looperã€ä¸» Handlerã€‚å¹¶ä½¿ä¸»çº¿ç¨‹è¿›å…¥ç­‰å¾…æ¥æ”¶ Message æ¶ˆæ¯çš„æ— é™å¾ªç¯çŠ¶æ€ã€‚å…³äº Android çš„ Handler æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘ä¸Šé¢æåˆ°çš„æ–‡ç« ï¼š
    [ã€æƒŠå¤©ç§˜å¯†ï¼ä» Thread å¼€å§‹ï¼Œæ­éœ² Android çº¿ç¨‹é€šè®¯çš„è¯¡è®¡å’Œä¸»çº¿ç¨‹çš„é˜´è°‹ã€‘http://www.jianshu.com/p/8862bd2b6a29](https://link.juejin.im?target=http%3A%2F%2Fwww.jianshu.com%2Fp%2F8862bd2b6a29)
    ä¸‹é¢æ˜¯ main() æ–¹æ³•ä¸­æ¯”è¾ƒå…³é”®çš„ä»£ç ï¼š

<pre>public static void main(String[] args){
    ...
    Looper.prepareMainLooper(); 
    //åˆå§‹åŒ–Looper
    ...
    ActivityThread thread = new ActivityThread();
    //å®ä¾‹åŒ–ä¸€ä¸ªActivityThread
    thread.attach(false);
    //è¿™ä¸ªæ–¹æ³•æœ€åå°±æ˜¯ä¸ºäº†å‘é€å‡ºåˆ›å»ºApplicationçš„æ¶ˆæ¯
    ... 
    Looper.loop();
    //ä¸»çº¿ç¨‹è¿›å…¥æ— é™å¾ªç¯çŠ¶æ€ï¼Œç­‰å¾…æ¥æ”¶æ¶ˆæ¯
}
</pre>

2\. è°ƒç”¨ attach() æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†å‘é€å‡ºåˆå§‹åŒ– Application çš„æ¶ˆæ¯ã€‚è¿™ä¸ªæµç¨‹è¯´é•¿ä¸é•¿ï¼Œè¯´çŸ­ä¸çŸ­ã€‚ä¸‹æ–‡ä¼šå†æ‹ä¸€æ‹ã€‚

## åˆ›å»º Application çš„æ¶ˆæ¯æ˜¯å¦‚ä½•å‘é€çš„å‘¢ï¼Ÿ

ä¸Šé¢æåˆ°è¿‡ï¼ŒActivityThread çš„ attach() æ–¹æ³•æœ€ç»ˆçš„ç›®çš„æ˜¯å‘é€å‡ºä¸€æ¡åˆ›å»º Application çš„æ¶ˆæ¯â€”â€”H.BIND_APPLICATIONï¼Œåˆ°ä¸»çº¿ç¨‹çš„ä¸» Handler ä¸­ã€‚é‚£æˆ‘ä»¬æ¥çœ‹çœ‹ attach() æ–¹æ³•å¹²äº†å•¥ã€‚
attach() å…³é”®ä»£ç ï¼š

<pre>public void attach(boolean system){
    ...
    final IActivityManager mgr = ActivityManagerNative.getDefault();  
    //è·å¾—IActivityManagerå®ä¾‹ï¼Œä¸‹é¢ä¼šçœ‹çœ‹å®ƒæ˜¯ä¸ªå•¥
    try {
        mgr.attachApplication(mAppThread);
         //çœ‹è§æ²¡ï¼Ÿå…³é”®å•Šã€‚mAppThreadè¿™ä¸ªå‚æ•°ä¸‹é¢ä¹Ÿä¼šè¯´ä¸€ä¸‹
    } catch (RemoteException ex) {
        throw ex.rethrowFromSystemServer();
    }
    ...
}
</pre>

è«æ…Œè«æ…Œï¼Œä¸‹é¢çœ‹çœ‹ä¸Šé¢å‡ºç°çš„ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸ªå•¥ã€‚

### IActivityManager mgr æ˜¯ä¸ªå•¥ï¼Ÿ

ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒIActivityManager æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå½“æˆ‘ä»¬è°ƒç”¨`ActivityManagerNative.getDefault()`è·å¾—çš„å®é™…æ˜¯ä¸€ä¸ªä»£ç†ç±»çš„å®ä¾‹â€”â€”**ActivityManagerProxy**ï¼Œè¿™ä¸ªä¸œè¥¿å®ç°äº† IActivityManager æ¥å£ã€‚æ‰“å¼€æºç ä½ ä¼šå‘ç°ï¼Œ**ActivityManagerProxy** æ˜¯ ActivityManagerNative çš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚å¯ä»¥çœ‹å‡ºï¼ŒAndroid å›¢é˜Ÿåœ¨è®¾è®¡çš„è¿‡ç¨‹ä¸­æ˜¯å®è·µäº†**æœ€å°æƒŠå¼‚åŸåˆ™**çš„ï¼Œå°±æ˜¯æŠŠç›¸å…³çš„ä¸œè¥¿å°½é‡æ”¾åœ¨ä¸€èµ·ã€‚é‚£ä¹ˆæ—¢ç„¶æ˜¯ä¸ªä»£ç†ç±»ï¼Œå®ƒç©¶ç«Ÿä»£ç†äº†è°ï¼Ÿä»£ç é‡Œçœ‹çœ‹å–½ğŸ˜ã€‚
ä¸‹é¢è¿™ä¸ªä»£ç ç¨å¾®æœ‰ç‚¹ç»•å•Šï¼è€å“¥ï¼Œç¨³ä½ï¼

1.  å…ˆçœ‹ ActivityManagerProxy çš„æ„é€ å‡½æ•°ï¼š

    <pre>public ActivityManagerProxy(IBinder remote) {
         mRemote = remote;
    }
    </pre>

    è¿™ä¸ªæ„é€ å‡½æ•°éå¸¸çš„ç®€å•ã€‚é¦–å…ˆå®ƒéœ€è¦ä¸€ä¸ª IBinder å‚æ•°ï¼Œç„¶åèµ‹å€¼ç»™ **mRemote** å˜é‡ã€‚è¿™ä¸ª **mRemote** æ˜¾ç„¶æ˜¯ ActivityManagerNative çš„æˆå‘˜å˜é‡ã€‚ä½†å¯¹å®ƒçš„æ“ä½œæ˜¯ç”± ActivityManagerProxy æ¥ä»£ç†é—´æ¥è¿›è¡Œçš„ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä¿æŠ¤äº† mRemoteï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ“ä½œ mRemote å‰æ‰§è¡Œä¸€äº›åˆ«çš„äº‹åŠ¡ï¼Œå¹¶ä¸”æˆ‘ä»¬æ˜¯ä»¥ IActivityManager çš„èº«ä»½æ¥è¿›è¡Œè¿™äº›æ“ä½œçš„ï¼è¿™å°±éå¸¸å·§å¦™äº†ğŸ‘ã€‚

2.  é‚£ä¹ˆè¿™ä¸ªæ„é€ å‡½æ•°æ˜¯åœ¨é‚£è°ƒç”¨çš„å‘¢ï¼Ÿ

    <pre>static public IActivityManager asInterface(IBinder obj) {
     if (obj == null) {
         return null;
     }
     IActivityManager in =
         (IActivityManager)obj.queryLocalInterface(descriptor);
     //å…ˆæ£€æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰
     if (in != null) {
         return in;
     }
     ...
     return new ActivityManagerProxy(obj);
     //è¿™ä¸ªåœ°æ–¹è°ƒç”¨äº†æ„é€ å‡½æ•°
    }
    </pre>

    ä¸Šé¢è¿™ä¸ªæ–¹æ³•æ˜¯ ActivityManagerNative ä¸­çš„ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå®ƒä¼šè°ƒç”¨åˆ° ActivityManagerProxy çš„æ„é€ æ–¹æ³•ã€‚ç„¶è€Œï¼Œè¿™ä¸ªé™æ€æ–¹æ³•ä¹Ÿéœ€è¦ä¸€ä¸ª IBinder ä½œä¸ºå‚æ•°! è€å¤«è¢«ç»•æ™•äº†ğŸ˜‚ã€‚ä½†æ˜¯ä¸æ€•ï¼Œå’±ä»¬ç»§ç»­å¾€æ‰¾ï¼

3.  getDefault() è·å–åˆ°çš„é™æ€å¸¸é‡ gDefault

    <pre>private static final Singleton<IActivityManager> gDefault = 
    new Singleton<IActivityManager>() {
     protected IActivityManager create() {
        IBinder b = ServiceManager.getService("activity");
        //é‡ç‚¹å•Šï¼IBinderå®ä¾‹å°±æ˜¯åœ¨è¿™é‡Œè·å¾—çš„ã€‚
         ...
         IActivityManager am = asInterface(b);
         //è°ƒç”¨äº†ä¸Šé¢çš„æ–¹æ³•ã€‚
         ...
         return am;
     }
    };
    </pre>

    è¿™æ˜¯ ActivityManagerNative çš„é™æ€å¸¸é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ã€‚åœ¨å…¶ä¸­ç»ˆäºè·å¾—äº†å‰é¢ä¸€ç›´åœ¨ç”¨çš„ IBinder å®ä¾‹ã€‚

    <pre>IBinder b = ServiceManager.getService("activity");
    </pre>

    è¯•ç€åœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®ã€‚

è¿™é‡Œæ˜¯é€šè¿‡ **ServiceManager** è·å–åˆ° **IBinder** å®ä¾‹çš„ã€‚å¦‚æœä½ ä»¥å‰äº†è§£ **AIDL** é€šè®¯æµç¨‹çš„è¯ã€‚è¿™å¯èƒ½æ¯”è¾ƒå¥½ç†è§£ä¸€ç‚¹ï¼Œè¿™åªæ˜¯é€šè¿‡å¦ä¸€ç§æ–¹å¼è·å– **IBinder** å®ä¾‹ç½¢äº†ã€‚è·å– **IBinder** çš„ç›®çš„å°±æ˜¯ä¸ºäº†é€šè¿‡è¿™ä¸ª **IBinder** å’Œ **ActivityManager** è¿›è¡Œé€šè®¯ï¼Œè¿›è€Œ **ActivityManager** ä¼šè°ƒåº¦å‘é€ **H.BIND_APPLICATION** å³åˆå§‹åŒ– Application çš„ Message æ¶ˆæ¯ã€‚å¦‚æœä¹‹å‰æ²¡æ¥è§¦è¿‡ **Binder** æœºåˆ¶çš„è¯ï¼Œåªéœ€çŸ¥é“è¿™ä¸ªç›®çš„å°±è¡Œäº†ã€‚æˆ‘åé¢ä¼šå†™ä¸€ç¯‡ä¸“é—¨ä»‹ç» Android ä¸­ Binder æœºåˆ¶çš„æ–‡ç« ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å‚è€ƒä¸€ä¸‹ç½—å¤§çš„ç³»åˆ—æ–‡ç« ï¼Œå†™çš„å¾ˆè¯¦ç»†ï¼Œéå¸¸çš„å¾ˆèµï¼ [ã€Android ç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ Binder æœºåˆ¶åœ¨åº”ç”¨ç¨‹åºæ¡†æ¶å±‚çš„ Java æ¥å£æºä»£ç åˆ†æ
ã€‘http://m.blog.csdn.net/article/details?id=6642463](https://link.juejin.im?target=http%3A%2F%2Fm.blog.csdn.net%2Farticle%2Fdetails%3Fid%3D6642463)ã€‚

1.  å†æ¥çœ‹çœ‹ attachApplication(mAppThread) æ–¹æ³•ã€‚

    <pre>public void attachApplication(IApplicationThread app){
    ...
    mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);  
    ...
    }
    </pre>

    è¿™ä¸ªæ–¹æ³•æˆ‘åœ¨ä¸Šå›¾ä¸­ä¹Ÿä½“ç°å‡ºæ¥äº†ã€‚

è¿™ä¸ªæ–¹æ³•ä¸­ä¸Šé¢è¿™ä¸€å¥æ˜¯å…³é”®ã€‚è°ƒç”¨äº† IBinder å®ä¾‹çš„ tansact() æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠå‚æ•° app(è¿™ä¸ªå‚æ•°ç¨åå°±ä¼šæåˆ°) æ”¾åˆ°äº† data ä¸­ï¼Œæœ€ç»ˆä¼ é€’ç»™ ActivityManagerã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬çŸ¥é“äº† IActivityManager æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œäº†ã€‚å…¶å®æœ€é‡è¦çš„å°±æ˜¯å®ƒçš„ä¸€ä¸ªå®ç°ç±» **ActivityManagerProxy**ï¼Œå®ƒä¸»è¦ä»£ç†äº†å†…æ ¸ä¸­ä¸ **ActivityManager** é€šè®¯çš„ **Binder** å®ä¾‹ã€‚ä¸‹é¢å†çœ‹çœ‹ **ApplicationThread mAppThread**ã€‚

### ApplicationThread mAppThread åˆæ˜¯ä¸ªå•¥ï¼Ÿ

1.  åœ¨ ActivityThread çš„æˆå‘˜å˜é‡ä¸­ï¼Œä½ èƒ½å¤Ÿå‘ç°ï¼š

    <pre>final ApplicationThread mAppThread = new ApplicationThread();
    </pre>

    ApplicationThread æ˜¯ä½œä¸º ActivityThread ä¸­çš„ä¸€ä¸ªå¸¸é‡å‡ºç°çš„ã€‚è¿™è¡¨æ˜ç³»ç»Ÿä¸å¸Œæœ›è¿™ä¸ªå˜é‡ä¸­é€”è¢«ä¿®æ”¹ï¼Œå¯è§è¿™ä¸ªå˜é‡å…·æœ‰ç‰¹å®šè€Œååˆ†é‡è¦çš„ä½œç”¨ã€‚
2.  æˆ‘ä»¬çœ‹çœ‹ä»–æ˜¯å•¥ã€‚

    <pre>private class ApplicationThread extends ApplicationThreadNative{
     ...
    }
    </pre>

    ApplicationThread æ˜¯ ActivityThread ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰å•ç‹¬å‡ºæ¥å†™åœ¨åˆ«çš„åœ°æ–¹å‘¢ï¼Ÿæˆ‘è§‰å¾—è¿™ä¹Ÿæ˜¯å¯¹æœ€å°æƒŠå¼‚åŸåˆ™çš„å®è·µã€‚å› ä¸º ApplicationThread æ˜¯ä¸“é—¨çœŸå¯¹è¿™é‡Œä½¿ç”¨çš„å¯¹è±¡ã€‚
3.  å®ƒç»§æ‰¿è‡ª ApplicationThreadNativeï¼Œæˆ‘ä»¬å†çœ‹çœ‹å®ƒæ˜¯ä¸ªå•¥ã€‚

    <pre>public abstract class ApplicationThreadNative extends Binder 
     implements IApplicationThread{
     ...
     //æ— å‚æ„é€ å‡½æ•°
     public ApplicationThreadNative() {
         //è¿™æ˜¯Binderçš„
         attachInterface(this, descriptor);
     }
     ...
    }
    </pre>

    é‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼ŒApplicationThread æœ€ç»ˆä¹Ÿæ˜¯ä¸€ä¸ª Binderï¼åŒæ—¶ï¼Œç”±äºå®ç°äº† IApplicationThread æ¥å£ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ä¸€ä¸ª IApplicationThreadã€‚ä»¥ä¸Šè¿™ç³»å¯¹åº”å…³ç³»ä½ éƒ½å¯ä»¥åœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°ã€‚

æˆ‘ä»¬åœ¨ ActivityThread ä¸­çœ‹åˆ°çš„ ApplicationThread ä½¿ç”¨çš„æ„é€ å‡½æ•°æ˜¯æ— å‚çš„ï¼Œæ‰€ä»¥çœ‹ä¸Šé¢æ— å‚æ„é€ å‡½æ•°éƒ½å¹²äº†å•¥ï¼

Binder çš„ attachInterface(IInterface owner, String descriptor) æ–¹æ³•æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯èµ‹å€¼äº†ã€‚

<pre>public void attachInterface(IInterface owner, String descriptor) {
    mOwner = owner;
    mDescriptor = descriptor;
}
</pre>

4\. é‚£ä¹ˆ IApplicationThread åˆæ˜¯å•¥ï¼Ÿè€é“ï¼Œèµ°ç€ï¼æˆ‘ä»¬ç»§ç»­æŒ–ã€‚

<pre>public interface IApplicationThread extends IInterface {
    ...
    String descriptor = "android.app.IApplicationThread"; 
    //ç•™æ„ä¸‹è¿™ä¸ªå‚æ•°
    ...
}
</pre>

å¥½å§ï¼Œè¿™åœ¨ä¸Šå›¾ä¸­æ²¡æœ‰ï¼ŒæŒ–çš„æœ‰ç‚¹ä»€ä¹ˆäº†ã€‚ä½†æ˜¯å­¦ä¹ å˜›ï¼Œå’±å°±çœ‹çœ‹å–½ã€‚

IApplicationThread æ˜¯ç»§æ‰¿äº† IInterface çš„ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨ä¸€ä¸‹é‡Œé¢çš„ descriptor å‚æ•°ã€‚åé¢ä¼šç”¨å®ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ‡è¯†ï¼ŒæŸ¥è¯¢çš„æ—¶å€™å¾ˆé‡è¦ã€‚

å¥½ï¼Œæˆ‘ä»¬ç»ˆäºçŸ¥é“ attach() æ–¹æ³•ä¸­å‡ºç°çš„ä¸¤ä¸ªå¯¹è±¡æ˜¯å•¥äº†ã€‚ApplicationThread ä½œä¸º IApplicationThread çš„ä¸€ä¸ªå®ä¾‹ï¼Œæ‰¿æ‹…äº†æœ€åå‘é€ Activity ç”Ÿå‘½å‘¨æœŸã€åŠå…¶å®ƒä¸€äº›æ¶ˆæ¯çš„ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰é¢ç»•äº†ä¸€å¤§åœˆï¼Œæœ€åè¿˜æ˜¯å›åˆ°è¿™ä¸ªåœ°æ–¹æ¥å‘é€æ¶ˆæ¯ã€‚æˆ‘æ“¦ï¼

ä¹Ÿè®¸ä½ ä¼šæƒ³ï¼Œæ—¢ç„¶åœ¨ ActivityThread ä¸­æˆ‘ä»¬å·²ç»åˆ›å»ºå‡ºäº† ApllicationThread çš„äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç»•è¿™ä¹ˆå¼¯è·¯ï¼ŸğŸ˜„ï¼Œå½“ç„¶æ˜¯ä¸ºäº†è®©ç³»ç»Ÿæ ¹æ®æƒ…å†µæ¥æ§åˆ¶è¿™ä¸ªè¿‡ç¨‹å–½ï¼Œä¸ç„¶ä¸ºä»€ä¹ˆè¦æŠŠ ApplicationThread ä¼ åˆ° ActivityManager ä¸­å‘¢ï¼Ÿ

### ActivityManagerService è°ƒåº¦å‘é€åˆå§‹åŒ–æ¶ˆæ¯

ç»è¿‡ä¸Šé¢çš„è¾—è½¬ï¼ŒApplicationThread ç»ˆäºåˆ°äº† ActivityManagerService ä¸­äº†ã€‚è¯·åœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®ï¼

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒActivityManagerService ä¸­æœ‰ä¸€è¿™æ ·çš„æ–¹æ³•ï¼š

<pre>private final boolean attachApplicationLocked(IApplicationThread thread
, int pid) {
    ...
    thread.bindApplication();
    //æ³¨æ„å•¦ï¼
    ...
}
</pre>

ApplicationThread ä»¥ IApplicationThread çš„èº«ä»½åˆ°äº† ActivityManagerService ä¸­ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„æ“ä½œï¼Œæœ€ç»ˆè¢«è°ƒç”¨äº†è‡ªå·±çš„ bindApplication() æ–¹æ³•ï¼Œå‘å‡ºåˆå§‹åŒ– Applicationd çš„æ¶ˆæ¯ã€‚

<pre>public final void bindApplication(String processName, 
    ApplicationInfo appInfo,
    List<ProviderInfo> providers, 
    ComponentName instrumentationName,
    ProfilerInfo profilerInfo, 
    Bundle instrumentationArgs,
    IInstrumentationWatcher instrumentationWatcher,
    IUiAutomationConnection instrumentationUiConnection, 
    int debugMode,
    boolean enableBinderTracking, 
    boolean trackAllocation,
    boolean isRestrictedBackupMode, 
    boolean persistent, 
    Configuration config,
    CompatibilityInfo compatInfo, 
    Map<String, IBinder> services, 
    Bundle coreSettings){

    ...
    sendMessage(H.BIND_APPLICATION, data);
}
</pre>

å“å±è€çº¸ï¼è¿™ä¹ˆå¤šå‚æ•°ã€‚è¿™æ˜æ˜å¾ˆè¿åå‚æ•°å°½é‡è¦å°‘çš„åŸåˆ™å˜›ï¼æ‰€ä»¥è¯´ï¼Œæœ‰çš„æ—¶å€™ï¼Œå¼€å‘è¿‡ç¨‹ä¸­è¿˜æ˜¯å¾ˆéš¾é¿å…ä¸€äº›å‚æ•°å †ç§¯çš„æƒ…å†µçš„ã€‚ä¹Ÿä¸èƒ½ä¸€æ¦‚è€Œè®ºã€‚

ä½†æ˜¯ï¼Œè¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“æœ€åå‘äº†ä¸€æ¡ **H.BIND_APPLICATION** æ¶ˆæ¯ï¼Œæ¥ç€ç¨‹åºå¼€å§‹äº†ã€‚

## æ”¶åˆ°åˆå§‹åŒ–æ¶ˆæ¯ä¹‹åçš„ä¸–ç•Œ

ä¸Šé¢æˆ‘ä»¬å·²ç»æ‰¾åˆ°åˆå§‹åŒ– Applicaitond çš„æ¶ˆæ¯æ˜¯åœ¨å“ªå‘é€çš„äº†ã€‚ç°åœ¨ï¼Œéœ€è¦çœ‹ä¸€çœ‹æ”¶åˆ°æ¶ˆæ¯åéƒ½å‘ç”Ÿäº†äº›ä»€ä¹ˆã€‚

ç°åœ¨ä¸Šå›¾çš„ H ä¸‹é¢æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š**H.BIND_APPLICATION**ã€‚ä¸€æ—¦æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯å°±å¼€å§‹åˆ›å»º Application äº†ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ handleBindApplication() ä¸­å®Œæˆçš„ã€‚çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ã€‚åœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚

<pre>private void handleBindApplication(AppBindData data) {
    ...
    mInstrumentation = (Instrumentation)
        cl.loadClass(data.instrumentationName.getClassName())
        .newInstance();
    //é€šè¿‡åå°„åˆå§‹åŒ–ä¸€ä¸ªInstrumentationä»ªè¡¨ã€‚åé¢ä¼šä»‹ç»ã€‚
    ...
    Application app = data.info.makeApplication(data.restrictedBackupMode, null);
    //é€šè¿‡LoadedAppå‘½ä»¤åˆ›å»ºApplicationå®ä¾‹
    mInitialApplication = app;
    ...
    mInstrumentation.callApplicationOnCreate(app);
    //è®©ä»ªå™¨è°ƒç”¨Applicationçš„onCreate()æ–¹æ³•
    ...
}
</pre>

handleBindApplication() æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä¸ºå„ä½çœ‹å®˜ç²¾é€‰å‡ºäº†ä¸Šé¢è¿™å‡ å¥ä»£ç ã€‚å¯¹äºæœ¬ç¯‡çš„ä¸»é¢˜æ¥è¯´ï¼Œä»–ä»¬æ˜¯è‡³å…³é‡è¦çš„ã€‚ä¸Šé¢çŸ­çŸ­çš„ä»£ç ä¸­å‡ºç°äº†å‡ ä¸ªæ–°å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä¼šä¸€ä¸€é“æ¥ã€‚

### Instrumentation ä»ªè¡¨ï¼Œä»€ä¹ˆé¬¼ï¼Ÿ

1\. è¿™ä¸ªå« Instrumentation ä»ªè¡¨çš„ä¸œè¥¿ååˆ†è¯¡å¼‚ï¼Œå§‘ä¸”ç¿»è¯‘ä¸ºä»ªå™¨å§ã€‚å­—é¢ä¸Šçœ‹ä¸å‡ºä»»ä½•å®ƒæ˜¯å¹²ä»€ä¹ˆçš„çº¿ç´¢ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€æ–‡æ¡£çœ‹çœ‹å–½ã€‚

> Instrumentation ä¼šåœ¨åº”ç”¨ç¨‹åºçš„ä»»ä½•ä»£ç è¿è¡Œä¹‹å‰è¢«å®ä¾‹åŒ–ï¼Œå®ƒèƒ½å¤Ÿå…è®¸ä½ ç›‘è§†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçš„æ‰€æœ‰äº¤äº’ã€‚

å¤§æ¦‚å°±è¿™ä¸ªæ„æ€å•¦ã€‚

2\. ä½†æ˜¯ï¼Œä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒInstrumentation ç¡®å®æ˜¯åœ¨ Application åˆå§‹åŒ–ä¹‹å‰å°±è¢«åˆ›å»ºäº†ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°ç›‘è§†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿäº¤äº’çš„å‘¢ï¼Ÿ

æ‰“å¼€è¿™ä¸ªç±»ä½ å¯ä»¥å‘ç°ï¼Œæœ€ç»ˆ Apllication çš„åˆ›å»ºï¼ŒActivity çš„åˆ›å»ºï¼Œä»¥åŠç”Ÿå‘½å‘¨æœŸéƒ½ä¼šç»è¿‡è¿™ä¸ªå¯¹è±¡å»æ‰§è¡Œã€‚ç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯æŠŠè¿™äº›æ“ä½œåŒ…è£…äº†ä¸€å±‚ã€‚é€šè¿‡æ“ä½œ Instrumentation è¿›è€Œå®ç°ä¸Šè¿°çš„åŠŸèƒ½ã€‚

3\. é‚£ä¹ˆè¿™æ ·åšç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿä»”ç»†æƒ³æƒ³ã€‚Instrumentation ä½œä¸ºæŠ½è±¡ï¼Œå½“æˆ‘ä»¬çº¦å®šå¥½éœ€è¦å®ç°çš„åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦ç»™ Instrumentation ä»ªè¡¨æ·»åŠ è¿™äº›æŠ½è±¡åŠŸèƒ½ï¼Œç„¶åè°ƒç”¨å°±å¥½ã€‚å‰©ä¸‹çš„ï¼Œä¸ç®¡æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½ï¼Œéƒ½äº¤ç»™ Instrumentation ä»ªå™¨çš„å®ç°å¯¹è±¡å°±å¥½ã€‚å•Šï¼è¿™æ˜¯å¤šæ€çš„è¿ç”¨ã€‚å•Šï¼è¿™æ˜¯ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“çš„å®è·µã€‚å•Šï¼è¿™æ˜¯ä¸Šå±‚æå‡ºéœ€æ±‚ï¼Œåº•å±‚å®šä¹‰æ¥å£ï¼Œå³ä¾èµ–å€’ç½®åŸåˆ™çš„è·µè¡Œã€‚å‘µï¼æŠ½è±¡ä¸è¿‡å¦‚æ­¤ã€‚

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå®ä¾‹åŒ– Instrumentation çš„æ–¹æ³•æ˜¯åå°„ï¼è€Œåå°„çš„ ClassName æ˜¯æ¥è‡ªäºä» ActivityManagerService ä¸­ä¼ è¿‡æ¥çš„ Binder çš„ã€‚å¥—è·¯å¤ªæ·±ï¼å°±æ˜¯ä¸ºäº†éšè—å…·ä½“çš„å®ç°å¯¹è±¡ã€‚ä½†æ˜¯è¿™æ ·è€¦åˆæ€§ä¼šå¾ˆä½ã€‚

4\. å¥½äº†ï¼Œä¸çæ‰¯äº†ã€‚æ—¢ç„¶åœ¨è¯´ Instrumentationï¼Œé‚£å°±çœ‹çœ‹æœ€åè°ƒçš„ callApplicationOnCreate() æ–¹æ³•ã€‚

<pre>public void callApplicationOnCreate(Application app) {
    app.onCreate();
}
</pre>

ä½ æ²¡çœ‹é”™ï¼Œå®ƒå•¥ä¹Ÿæ²¡å¹²ã€‚åªæ˜¯è°ƒç”¨äº†ä¸€ä¸‹ Application çš„ onCreate() æ–¹æ³•ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒèƒ½å¤Ÿèµ·åˆ°ç›‘æ§çš„ä½œç”¨ã€‚

åœ¨ä¸Šå›¾ä¸­ä½ èƒ½å¤Ÿçœ‹åˆ° Instrumentationï¼Œä»¥åŠå®ƒçš„äº¤äº’è¿‡ç¨‹ã€‚

### LoadedApk å°±æ˜¯ data.info å“¦ï¼

å…³äºå®ƒæ˜¯æ€ä¹ˆæ¥çš„æœ¬ç¯‡å°±ä¸è¯´äº†ï¼Œä»¥åå¯èƒ½ä¼šä»‹ç»ä¸‹ã€‚æœ¬ç¯‡å°±çœ‹æµç¨‹å°±å¥½ã€‚æ‰€ä»¥ç›´æ¥è¿›å»çœ‹å®ƒçš„ makeApplication() å¹²äº†å•¥ï¼Œå°±æŠŠ Application ç»™åˆ›å»ºäº†ã€‚

<pre>public Application makeApplication(boolean forceDefaultAppClass,
    Instrumentation instrumentation) {
    ...
    String appClass = mApplicationInfo.className;
    //Applicationçš„ç±»åã€‚æ˜æ˜¾æ˜¯è¦ç”¨åå°„äº†ã€‚
    ...
    ContextImpl appContext = ContextImpl.createAppContext(mActivityThread
        , this);
    //ç•™æ„ä¸‹Context
    app = mActivityThread.mInstrumentation
        .newApplication( cl, appClass, appContext);
    //é€šè¿‡ä»ªè¡¨åˆ›å»ºApplication
    ...
}
</pre>

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ï¼Œåœ¨å–å¾— Application çš„å®é™…ç±»åä¹‹åï¼Œæœ€ç»ˆçš„åˆ›å»ºå·¥ä½œè¿˜æ˜¯äº¤ç”± Instrumentation å»å®Œæˆï¼Œå°±åƒå‰é¢æ‰€è¯´çš„ä¸€æ ·ã€‚

å€¼å¾—ç•™æ„çš„æ˜¯ï¼Œå°±åƒä¸Šå›¾æ‰€æ ‡æ³¨çš„ä¸€æ ·ï¼Œå½“éœ€è¦ç¬¬äºŒæ¬¡è·å– Application æ—¶ï¼ŒåŒæ ·åªéœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¥½ã€‚â€œçœŸæ˜¯æ–¹ä¾¿ï¼â€

### ç°åœ¨æŠŠç›®å…‰ç§»å› Instrumentation

çœ‹çœ‹ newApplication() ä¸­æ˜¯å¦‚ä½•å®Œæˆ Application çš„åˆ›å»ºçš„ã€‚

<pre>static public Application newApplication(Class<?> clazz
    , Context context) throws InstantiationException
    , IllegalAccessException
    , ClassNotFoundException {
        Application app = (Application)clazz.newInstance();
        //åå°„åˆ›å»ºï¼Œç®€å•ç²—æš´
        app.attach(context);
        //å…³æ³¨ä¸‹è¿™é‡Œï¼ŒApplicationè¢«åˆ›å»ºåç¬¬ä¸€ä¸ªè°ƒç”¨çš„æ–¹æ³•ã€‚
        //ç›®çš„æ˜¯ä¸ºäº†ç»‘å®šContextã€‚
        return app;
    }
</pre>

æˆ‘çš„å¤©ï¼Œç»•äº†è¿™ä¹ˆå¤šï¼Œè¿™ Application å¯ç®—æ˜¯åˆ›å»ºå‡ºæ¥äº†ã€‚å¿«ç»™è‡ªå·±ä¸€ä¸ªå°çº¢èŠ±å§ğŸ˜Šï¼

## LaunchActivity

å½“ Application åˆå§‹åŒ–å®Œæˆåï¼Œç³»ç»Ÿä¼šæ›´å…· Manifests ä¸­çš„é…ç½®çš„å¯åŠ¨ Activity å‘é€ä¸€ä¸ª Intent å»å¯åŠ¨ç›¸åº”çš„ Activityã€‚è¿™ä¸ªè¿‡ç¨‹æœ¬ç¯‡å…ˆä¸æï¼Œä¸‹æ¬¡å†è¯´ã€‚ä¸»è¦çœ‹æµç¨‹ï¼

1.  ç›´æ¥çš„ï¼ŒH å°±æ”¶åˆ°äº†ä¸€æ¡ LAUNCH_ACTIVITY çš„æ¶ˆæ¯ã€‚ç„¶åå¼€å§‹åˆå§‹åŒ– Activity ä¹‹æ—…ã€‚æ”¶åˆ°æ¶ˆæ¯åï¼ŒçœŸæ­£å¤„ç†æ˜¯åœ¨ ActivityThread ä¸­çš„ handleLaunchActivity() ä¸­è¿›è¡Œçš„ã€‚æ˜¯ä¸æ˜¯è¿«ä¸åŠå¾…çš„æƒ³è¦çŸ¥é“å‘ç”Ÿäº†å•¥ï¼Ÿå¿«åœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°å¯¹åº”çš„æ­¥éª¤å§ï¼

    <pre>private void handleLaunchActivity(ActivityClientRecord r
     , Intent customIntent
     , String reason) {
     ...
     Activity a = performLaunchActivity(r, customIntent);
     //å¦ˆè›‹ï¼åˆå°è£…åˆ°å¦ä¸€ä¸ªæ–¹æ³•ä¸­åˆ›å»ºäº†ã€‚
     ...
     if (a != null) {
         ...
         handleResumeActivity(r.token
         , false
         , r.isForward
         ,!r.activity.mFinished && !r.startsNotResumed
         , r.lastProcessedSeq, reason);
         //Activityåˆ›å»ºæˆåŠŸå°±å¾€onResume()èµ°äº†ï¼
         ...
     }
    }
    </pre>

    ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡º... å¥½å§ï¼Œä»€ä¹ˆéƒ½çœ‹ä¸å‡ºæ¥ï¼
2.  å†èµ°ä¸€ä¸ªæ–¹æ³•ã€‚

    <pre>private Activity performLaunchActivity(ActivityClientRecord r
     , Intent customIntent) {
     ...
     activity = mInstrumentation.newActivity(
          cl, component.getClassName(), r.intent);
     //é€šè¿‡ä»ªè¡¨æ¥åˆ›å»ºActivity
     ...
      Application app = r.packageInfo.makeApplication(false
      , mInstrumentation);
      //å‰é¢è¯´è¿‡ï¼Œæ˜¯åœ¨è·å–Application
     ...
     activity.attach(appContext
         , this
         , getInstrumentation()
         , r.token
         ,.ident
         , app
         , r.intent
         , r.activityInfo
         , title
         , r.parent
         , r.embeddedID
         , r.lastNonConfigurationInstances
         , config
         ,r.referrer
         , r.voiceInteractor
         , window);
     //æ–¹æ³•æ€ªå‡ºç°ï¼
     ...
     if (r.isPersistable()) {
         mInstrumentation.callActivityOnCreate(
           activity, r.state, r.persistentState);
     } else {
         mInstrumentation.callActivityOnCreate(activity, r.state);
     }
     //æ ¹æ®æ˜¯å¦å¯æŒä¹…åŒ–é€‰æ‹©onCreate()æ–¹æ³•ã€‚
     ...
    }
    </pre>

    è¿™ä¸ªæ–¹æ³•å†…å®¹è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªçœ‹ã€‚
3.  <pre>activity = mInstrumentation.newActivity(
          cl, component.getClassName(), r.intent);
    </pre>

    æ­£å¦‚å‰é¢æ‰€è¯´ï¼ŒActivityã€Application çš„åˆ›å»ºåŠç”Ÿå‘½å‘¨æœŸéƒ½è¢«æ‰¿åŒ…ç»™ Instrumentation ä»ªè¡¨äº†ã€‚æ‰€ä»¥ç”±å®ƒæ¥è´Ÿè´£ã€‚çœ‹çœ‹ Instrumentation å¹²äº†å•¥ã€‚

    <pre>public Activity newActivity(ClassLoader cl, String className,
             Intent intent)
             throws InstantiationException
             , IllegalAccessException,
             ClassNotFoundException {
         return (Activity)cl.loadClass(className).newInstance();
         //çœŸçš„æ²¡å¹²å•¥ã€‚åå°„å®ä¾‹åŒ–Activityè€Œå·²
     }
    </pre>

    å°±æ˜¯åå°„å‡ºä¸€ä¸ª Activity è€Œå·²ã€‚

4.  <pre>if (r.isPersistable()) {
         mInstrumentation.callActivityOnCreate(
           activity, r.state, r.persistentState);
     } else {
         mInstrumentation.callActivityOnCreate(activity, r.state);
     }
    </pre>

    æ ¹æ®æ˜¯å¦å¯æŒä¹…åŒ–é€‰æ‹© Activity çš„ onCreate() æ–¹æ³•ã€‚åŒæ ·æ˜¯é€šè¿‡ Instrumentation ä»ªè¡¨æ¥æ‰§è¡Œ onCreate() çš„ã€‚å®ƒä¸¤åˆ†åˆ«å¯¹åº”çš„ onCreate() æ–¹æ³•ä¸ºï¼š

    <pre>onCreate(icicle, persistentState);
    //å¯è·å¾—æŒä¹…åŒ–æ•°æ®
    </pre>

    å’Œ

    <pre>onCreate(icicle);
    //å¹³æ—¶é‡å†™çš„æœ€å¤šçš„ã€‚
    </pre>

ä¸­é—´ä¸¤ä¸ªæ–¹æ³•ç•™æ„ä¸€ä¸‹å°±å¥½ï¼Œå°±ä¸åœ¨è§£é‡Šçš„ï¼Œæ„Ÿå…´è¶£çš„ç‚¹æºç çœ‹çœ‹ã€‚

åˆ°æ­¤ï¼ŒActivity å°±è·‘èµ·æ¥äº†ï¼æ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å¹¶ä¸å¤æ‚ã€‚

# æ€»ç»“

æœ¬ç¯‡å°±åˆ°æ­¤ç»“æŸäº†ã€‚æœ¬ç¯‡ä¸»è¦æµç¨‹æ˜¯ä» Application åˆ›å»ºå¼€å§‹ï¼Œåˆ°ç¬¬ä¸€ä¸ª Activity onCreate() ç»“æŸçš„ã€‚è¿™äº†æµç¨‹ä¹Ÿä¸ç®—é•¿ï¼Œå…³é”®æ˜¯ç»“åˆä¸Šé¢çš„å›¾æ¥çœ‹ã€‚é‡ç‚¹ç¯èŠ‚æˆ‘éƒ½ç”¨ä¸åŒçš„é¢œè‰²æ ‡è®°å‡ºæ¥äº†ã€‚

çœ‹åˆ°è¿™é‡Œçš„åŒå­¦å¥–åŠ±è‡ªå·±ä¸€åŒ…è¾£æ¡å§ï¼ğŸ˜„

# å‚è€ƒé“¾æ¥

1.  [ã€Android ç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ Binder æœºåˆ¶åœ¨åº”ç”¨ç¨‹åºæ¡†æ¶å±‚çš„ Java æ¥å£æºä»£ç åˆ†æ
    ã€‘http://m.blog.csdn.net/article/details?id=6642463](https://link.juejin.im?target=http%3A%2F%2Fm.blog.csdn.net%2Farticle%2Fdetails%3Fid%3D6642463)

2.  [ã€Instrumentation APIã€‘https://developer.android.com/reference/android/app/Instrumentation.html](https://link.juejin.im?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fapp%2FInstrumentation.html)

3.  [ã€Activity å¯åŠ¨æµç¨‹ï¼ˆä¸‹ï¼‰ã€‘http://www.jianshu.com/p/3cf90c633bb1](https://link.juejin.im?target=http%3A%2F%2Fwww.jianshu.com%2Fp%2F3cf90c633bb1)
4.  [ã€Android å­¦ä¹ â€”â€”ActivityManager ä¸ Proxy æ¨¡å¼çš„è¿ç”¨ã€‘http://www.cnblogs.com/bastard/archive/2012/05/25/2517522.html](https://link.juejin.im?target=http%3A%2F%2Fwww.cnblogs.com%2Fbastard%2Farchive%2F2012%2F05%2F25%2F2517522.html)
5.  [ã€ActivityManager APIã€‘https://developer.android.com/reference/android/app/ActivityManager.html](https://link.juejin.im?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fapp%2FActivityManager.html)

**æ„Ÿè°¢ä½ çš„é˜…è¯»ã€‚å¦‚æœä½ è§‰å¾—å¯¹ä½ æœ‰ç”¨çš„è¯ï¼Œè®°å¾—ç»™ CoorChice ç‚¹ä¸ªèµï¼Œæ·»åŠ ä¸‹å…³æ³¨å“¦ï¼Œè°¢è°¢ğŸ˜˜ï¼**